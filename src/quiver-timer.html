<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../bower_components/app-layout/app-box/app-box.html">

<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/app-layout/app-scrollpos-control/app-scrollpos-control.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="icons.html">

<link rel="import" href="shared-styles.html">
<link rel="import" href="controllers/nav-controller.html">
<link rel="import" href="controllers/auth-controller.html">
<link rel="import" href="controllers/cast-controller.html">
<link rel="import" href="timer-fab/timer-fab.html">
<link rel="import" href="dialogs/item-name-dialog.html">
<link rel="import" href="dialogs/period-select-sheet.html">
<link rel="import" href="dialogs/settings-dialog.html">
<link rel="import" href="dialogs/sound-dialog.html">
<link rel="import" href="flash-alert/flash-alert.html">

<script src="../bower_components/lodash/lodash.js"></script>

<!-- Firestore -->
<script src="https://www.gstatic.com/firebasejs/3.5.0/firebase.js"></script>


<dom-module id="quiver-timer">
  <template>
    <style include="app-grid-style shared-styles">
      :host {
        --color-rich-black: #080705;
        --color-maastricht-blue: #011627;
        --color-metallic-seaweed: #1C898E;
        --color-gainsboro: #DDD1D9;
        --color-medium-candy-apple-red: #E01130;
        --color-white: #FFFFFF;
        
        --app-primary-color: var(--color-metallic-seaweed);
        --app-secondary-color: var(--color-gainsboro);
        
        --primary-color: var(--color-metallic-seaweed);
        --primary-text-color: var(--color-white);
        --primary-background-color: var(--color-white);
        --dark-primary-color: var(--color-maastricht-blue);
        --light-primary-color: var(--color-gainsboro);
        --default-primary-color: var(--color-metallic-seaweed);
        
        --secondary-color: var(--color-gainsboro);
        --secondary-text-color: var(--color-white);
        
        --accent-color: var(--color-medium-candy-apple-red);

        --disabled-text-color: var(--color-gainsboro);
        --divider-color: var(--color-maastricht-blue);
        /* Components */
        /* paper-drawer-panel */
        --drawer-menu-color: var(--color-gainsboro);
        --drawer-border-color: 1px solid var(--color-maastricht-blue);
        --drawer-toolbar-border-color: 1px solid var(--color-maastricht-blue);
        /* paper-menu */
        --paper-menu-background-color: var(--color-white);
        /* paper-input */
        /*--paper-input-container-color: rgba(255, 255, 255, 0.64);
        --paper-input-container-focus-color: rgba(255, 255, 255, 1);
        --paper-input-container-input-color: #fff;*/
        --paper-input-container-color: var(--color-white);
        --paper-input-container-focus-color: var(--color-metallic-seaweed);
        --paper-input-container-input-color: var(--color-white);
        /* paper-dialog */
        --paper-dialog-background-color: var(--color-rich-black);
        --paper-dialog-color: var(--color-white);
        /* paper-button */
        --paper-button-primary: var(--color-medium-candy-apple-red);
        --paper-button-secondary: var(--color-metallic-seaweed);
        --paper-button-tertiary: var(--color-maastricht-blue);
        --paper-button-google: var(--color-medium-candy-apple-red);
        --paper-button-facebook: var(--color-metallic-seaweed);
        /*paper-checkbox*/
        --paper-checkbox-checked-color: var(--color-maastricht-blue);
        /*paper-toggle*/
        /*app-grid*/
        --app-grid-columns: 1;
        /*--app-grid-item-height: 33%;*/
        display: block;

        --paper-icon-item: {
          color: var(--dark-primary-color);  
        }

        /*--paper-checkbox-checked-background-color: var(--color-gainsboro);*/
        --paper-checkbox-unchecked-color: var(--color-white);
        --paper-checkbox-checked-color: var(--color-white);
        --paper-checkbox-checkmark-color: var(--dark-primary-color);
        

        --paper-item-body-secondary: {
          color: var(--dark-primary-color);
        }
      }
      
      #main {
        padding: 1rem;
      }

      landing-view {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
      }
    </style>

<iron-ajax auto url="/env.client.json" handle-as="json" last-response="{{rawEnv}}"></iron-ajax>
<app-location id="appLocation" route="{{route}}" on-location-changed="_locationChanged"></app-location>
<app-route id="appRoute" route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}"></app-route>
<app-scrollpos-control selected="{{page}}"></app-scrollpos-control>
<flash-alert id="flashAlert" flash="[[settings.flash]]" sound="[[settings.sound]]" sound-file="[[settings.soundFile]]"></flash-alert>
<auth-controller id="authController" firebase="[[firebase]]" login-endpoint="[[model.user.write.login]]" connected="[[connected]]"
  page="[[page]]" user="{{user}}"></auth-controller>
<cast-controller route="[[route]]"></cast-controller>
<paper-toast id="toast"></paper-toast>


<!-- Main content -->
<div id="main" class="app-grid">
  <nav-controller page="[[page]]" tail="{{subroute}}"></nav-controller>
  <iron-pages selected="[[page]]" attr-for-selected="name" fallback-selection="fourohfour" role="main">
    <landing-view id="landingView" name="landing"></landing-view>
    <login-view id="loginView" name="login" user="[[user]]"></login-view>
    <timers-view id="timersView" name="timers" session="[[session]]"></timers-view>
    <timer-view id="timerView" name="timer" local-route="[[subroute]]" session="[[session]]"></timer-view>
    <configure-view id="configureView" local-route="[[subroute]]" session="[[session]]" name="configure" title="{{configureTitle}}"
      on-bulk-changed="toggleConfigureSheet" sheet-payload="{{periodSelectSheetPayload}}"></configure-view>
    <fourohfour-view id="fourohfourView" name="fourohfour"></fourohfour-view>
  </iron-pages>
</div>

<!-- Dialogs -->
<item-name-dialog id="itemNameDialog"></item-name-dialog>
<settings-dialog id="settingsDialog" settings="{{settings}}"></settings-dialog>
<sound-dialog id="soundDialog"></sound-dialog>

<!-- Bottom sheet -->
<period-select-sheet id="periodSelectSheet" show="[[showPeriodSelectSheet]]" show-bulk-edits="[[showBulkEdits]]" payload="[[periodSelectSheetPayload]]"></period-select-sheet>
</template>

<script>
    Polymer({
      is: 'quiver-timer',

      properties: {
        firebase: {
          type: Object,
          computed: '_firebase(env.firebaseConfig)'
        },
        env: {
          type: Object,
          computed: '_env(rawEnv)'
        },
        model: {
          type: Object,
          computed: '_model(rawEnv, env.firebaseConfig, env.environment)'
        },
        connected: {
          type: Boolean,
          value: false
        },
        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },
        session: {
          type: String,
          value: '123456'
        },
        settings: {
          type: Object,
          value: {
            flash: true,
            sound: true,
            soundFile: 'chime'
          }
        }
      },

      // Computed
      _firebase: function (firebaseConfig) {
        firebase.initializeApp(firebaseConfig);
        return firebase;
      },

      _env: function (env) {
        return _.merge(env.defaults, env[location.hostname.split('.').join(':')]);
      },

      _model: function (env, firebaseEnv, environment) {
        function normalizeModel(model) {
          var keys = Object.keys(model);
          var i = keys.length;
          var result = {};
          var key;
          var item;
          while (i--) {
            key = keys[i];
            item = model[key];
            result[key] = typeof item == 'string' ? firebaseEnv.root + '/' + environment + item : normalizeModel(item);
          }
          return result;
        };
        return normalizeModel(env.model);
      },

      // Observers
      observers: [
        '_connected(firebase)',
        '_routePageChanged(routeData.page)'
      ],

      _connected: function (firebase) {
        firebase.database().ref().child('.info/connected').on('value', function (snap) {
          this.connected = snap.val();
        }.bind(this));
      },

      _routePageChanged: function (page) {
        this.page = page || 'landing';
        this.showPeriodSelectSheet = page == 'configure';
        if (page == 'timers' && this.$.timersView.attached) this.$.timersView.attached();
        if (page == 'timer' && this.$.timerView.attached) this.$.timerView.attached();
        if (page == 'configure' && this.$.configureView.attached) this.$.configureView.attached();
      },

      _pageChanged: function (page) {
        // Load page import on demand. Show 404 page if fails
        var resolvedPageUrl = this.resolveUrl('views/' + page + '-view.html');
        this.importHref(resolvedPageUrl, null, this._showPage404, true);
      },

      _showPage404: function () {
        this.page = 'fourohfour';
      },

      // Listeners
      listeners: {
        redirect: '_redirect',
        back: '_back',
        scrollIntoView: '_scrollIntoView',
        openDialog: '_openDialog',
        timerFab: '_timerFab',
        flash: '_flash',
        sound: '_sound',
        testSound: '_testSound',
        enableSound: '_enableSound',
        disableSound: '_disableSound',
        login: '_login',
        logout: '_logout',
        openSettings: 'openSettings',
        error: '_error',
        restoreDefaults: 'restoreDefaults'
      },

      _redirect: function (e) {
        this.set('route.path', e.detail);
      },

      _back: function () {
        window.history.go(-1);
      },

      _scrollIntoView: function (e) {
        e.detail.scrollIntoView({ behavior: 'smooth' });
      },

      _openDialog: function (e) {
        this.$[e.detail.id].open(e);
      },

      _timerFab: function (e) {
        var payload = e.detail;
        this.timerFabPayload = {
          icon: payload.icon || false,
          url: payload.url || false,
          callback: payload.callback || false
        };
      },

      _flash: function (e) {
        if (this.settings.flash) {
          this.$.flashAlert.fireFlash();
        }
        if (this.settings.sound) {
          this.$.flashAlert.fireSound();
        }
      },

      _sound: function () {
        this.$.flashAlert.fireSound();
      },

      _testSound: function () {
        this.$.flashAlert.testSound();
      },

      _enableSound: function () {
        this.$.soundDialog.open();
      },

      _disableSound: function () {
        this.$.settingsDialog.disableSound();
      },

      _login: function (e) {
        var provider = e.detail;
        if (provider == 'google') {
          this.$.authController.google();
        } else if (provider == 'facebook') {
          this.$.authController.facebook();
        }
      },

      _logout: function () {
        this.$.authController.logout();
      },

      _error: function (e) {
        this.alert(e.detail.toString(), 5000);
      },

      // Functions
      clearLocalStorage: function () {
        localStorage.clear();
        location = location.pathname + '?now=' + Date.now();
      },

      toggleConfigureSheet: function (e) {
        this.showBulkEdits = e.detail.value;
      },

      openSettings: function () {
        this.$.settingsDialog.open();
      },

      alert: function (message, duration) {
        var tempDuration = this.$.toast.duration;
        if (duration) {
          this.$.toast.duration = duration;
        }
        this.$.toast.text = message;
        this.$.toast.show();
        setTimeout(function () {
          this.$.toast.duration = tempDuration;
        }.bind(this), tempDuration);
      },

      restoreDefaults: function() {
        this.$.timersView.restoreDefaults();
      }
    });
  </script>
</dom-module>