<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="cast-controller">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>
</template>
<script>
  Polymer({
    is: "cast-controller",

    properties: {
      route: Object,
      castUrl: String,
      sessionState: String,
      isAvailable: {
        type: Boolean,
        value: false
      },
      instance: {
        type: Object,
        computed: '_instance(isAvailable)'
      },
      castSession: {
        type: Object,
        computed: '_castSession(instance, sessionState)'
      },
      request: {
        type: Object,
        computed: '_request(isAvailable, castUrl)'
      },
      playerController: {
        type: Object,
        computed: '_playerController(isAvailable)'
      }
    },

    attached: function () {
      window.__onGCastApiAvailable = this.initializeCast.bind(this);
    },

    // Observers
    observers: [
      '_route(route.path)',
      '_loadMedia(request, castSession)',
      '_playerEvents(playerController)'
    ],

    _route: function (path) {
      return path.match(/(playing|paused)/) ? this.fire('showCast') : this.fire('hideCast');
    },

    _loadMedia: function (request, castSession) {
      if (!request || !castSession) return;
      return castSession.loadMedia(request)
        .then(function () {
          console.log('load media success', arguments);
        })
        .catch(function (err) {
          var error = err.toString();
          this.fire('error', 'Chromecast error: ' + error);
        }.bind(this));
    },

    _playerEvents: function(playerController) {
      playerController.addEventListener(cast.framework.RemotePlayerEventType.IS_CONNECTED_CHANGED, function (e) {
        console.log('ctrl connected changed', e);
      });
      playerController.addEventListener(cast.framework.RemotePlayerEventType.SESSION_STATE_CHANGED, function (e) {
        console.log('ctrl session state changed', e);
      });
    },

    _instance: function (isAvailable) {
      if (!isAvailable) return;
      var instance = cast.framework.CastContext.getInstance();
      instance.setOptions({
        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
      });
      instance.addEventListener(cast.framework.CastContextEventType.SESSION_STATE_CHANGED, function (e) {
        this.set('sessionState', e.sessionState);
      }.bind(this));
      return instance;
    },

    _castSession: function (instance, sessionState) {
      return instance.getCurrentSession();
    },

    _request: function (isAvailable, castUrl) {
      if (!isAvailable) return;

      var mediaInfo = new chrome.cast.media.MediaInfo(castEndpoint, 'text/html');
      return new chrome.cast.media.LoadRequest(mediaInfo);
    },

    _playerController: function (isAvailable) {
      if (!isAvailable) return;
      var player = new cast.framework.RemotePlayer();
      return new cast.framework.RemotePlayerController(player);
    },

    // Functions
    initializeCast: function (isAvailable) {
      this.isAvailable = isAvailable;
    },

  });
</script>
</dom-module>