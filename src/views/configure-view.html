<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-pouchdb/app-pouchdb-document.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../bower_components/marked-element/marked-element.html">

<link rel="import" href="../shared-styles.html">
<link rel="import" href="../color-wheel.html">
<link rel="import" href="../timer-behavior/timer-defaults.html">
<link rel="import" href="../digital-clock/digital-clock.html">
<link rel="import" href="../configure-period/configure-period.html">

<script src="../third-party/lodash.custom.min.js"></script>

<dom-module id="configure-view">
  <template>
    <style include="shared-styles color-wheel">
      :host {
        display: block;
        --paper-fab-background: var(--primary-color);
      }

      #periods-wrapper {
        position: relative;
        @apply(--shadow-elevation-2dp);
      }

      #timer-description {
        margin-left: 10px;
      }
    </style>

<app-route route="{{localRoute}}" pattern="/:timerKey" data="{{routeData}}" tail="{{subroute}}"></app-route>

<app-pouchdb-document id="periodsStorage" db-name="quiver-timer" doc-id="periods" data="{{periodsData}}"></app-pouchdb-document>
<app-pouchdb-document id="timerNameStorage" db-name="quiver-timer" doc-id="timer-name" data="{{timerNameData}}"></app-pouchdb-document>
<app-pouchdb-document id="timerDescriptionStorage" db-name="quiver-timer" doc-id="timer-description" data="{{timerDescriptionData}}"></app-pouchdb-document>
<app-pouchdb-document id="timersStorage" db-name="quiver-timer" doc-id="timers" data="{{timersData}}"></app-pouchdb-document>

<div id="top-title" class="layout vertical">
  <h3 id="title" on-click="editName">[[timerName]]</h3>
  <digital-clock id="totalSeconds" total-seconds="[[totalSeconds]]"></digital-clock>
</div>

<div style="margin-left: 10px;">
  <marked-element markdown="[[timerDescription]]" on-click="editDescription"></marked-element>  
</div>

<div style="padding: 0rem 1rem 6rem;">
<div id="periods-wrapper">
  <paper-fab id="top-fab" icon="save" on-click="save"></paper-fab>
  <template id="periods" is="dom-repeat" items="{{periods}}" as="period">
    <configure-period class="divided" period="{{period}}" rev="[[period._rev]]" on-period-updated="updatePeriodHandler" index="[[index]]"
      periods-count="[[periods.length]]"></configure-period>
  </template>
</div>
<div class="layout horizontal end-justified" style="padding: 30px 24px;" hidden$="[[!showSelectAll]]">
<paper-checkbox id="toggleCheckbox" on-checked-changed="toggleSelectAll"></paper-checkbox>
</div>
</div>
</template>
<script>
  var newTimerName = 'New Timer';
  var newTimerDescription = 'Add description';
  Polymer({
    is: "configure-view",

    behaviors: [TimerDefaults],

    properties: {
      localRoute: Object,
      session: String,
      title: {
        type: String,
        notify: true,
        computed: '_title(timerName)'
      },
      timerKey: {
        type: String,
        computed: '_timerKey(routeData.timerKey)'
      },
      timersData: Object,
      timers: {
        type: Array,
        computed: '_value(timersData.value)'
      },
      timerNameData: Object,
      timerName: {
        type: String,
        computed: '_timerName(timerNameData.value)'
      },
      timerDescriptionData: Object,
      timerDescription: {
        type: String,
        computed: '_timerDescription(timerDescriptionData.value)'
      },
      periodsData: Object,
      periods: {
        type: Array,
        computed: '_periods(periodsData, periodsData._rev)'
      },
      totalSeconds: {
        type: Number,
        computed: '_totalSeconds(periods, periodsData._rev)'
      },
      selected: {
        type: Array,
        value: [],
        notify: true
      },
      bulk: {
        type: Boolean,
        computed: '_bulk(periods, periodsData.value)',
        notify: true
      },
      sheetPayload: {
        type: Object,
        notify: true
      },
      storageReady: Boolean,
      showSelectAll: {
        type: Boolean,
        computed: '_showSelectAll(periods.length)'
      }
    },

    attached: function () {
      this.sheetPayload = this._sheetPayload();
    },

    _title: function (name) {
      return name;
    },

    // Observers
    observers: [
      '_setEditing(routeData.timerKey, timersData)'
    ],

    _setEditing: function (timerKey, timersData) {
      if (timersData.value && timersData.value[timerKey]) {
        this.set('timerNameData.value', timersData.value[timerKey].name);
        this.set('timerDescriptionData.value', timersData.value[timerKey].description);
        this.set('periodsData.value', timersData.value[timerKey].periods);

      }
    },

    _timerKey: function (timerKey) {
      return timerKey;
    },

    _value: function (value) {
      return value;
    },

    _timerName: function (value) {
      return value || newTimerName;
    },

    _timerDescription: function (value) {
      return value || newTimerDescription;
    },

    _periods: function (periodsData) {
      if (periodsData.value && periodsData.value.length) return _.clone(periodsData.value || []);
      this.addDefaultPeriod();
    },

    _totalSeconds: function (periods) {
      return !periods ? 0 : periods.reduce(function (seconds, period) {
        return seconds + period.totalSeconds;
      }, 0);
    },

    _bulk: function (periods) {
      return !periods ? false : !!periods.find(function (period) {
        return period.selected;
      });
    },

    _sheetPayload: function () {
      return {
        cancel: this.clearSelected.bind(this),
        duplicate: this.duplicateSelected.bind(this),
        delete: this.deleteSelected.bind(this),
        addWork: this.addWork.bind(this),
        addRest: this.addRest.bind(this),
        addStopwatch: this.addStopwatch.bind(this),
      };
    },

    _showSelectAll: function (i) {
      return i > 2;
    },

    // Listeners
    listeners: {
      moveUp: 'moveUp',
      moveDown: 'moveDown',
      delete: 'delete',
      select: 'select'
    },

    moveUp: function (e) {
      if (e.detail < 1) return console.log('skipping up');
      var index = e.detail.index;
      var period = this._cleanPeriod(this.periods[index]);
      this.periodsData.value.splice(index, 1);
      this.periodsData.value.splice(index - 1, 0, period);
      setTimeout(e.detail.callback);
      this._periodsSave();
    },

    moveDown: function (e) {
      if (e.detail >= this.periods.length - 1) return console.log('skipping up');
      var index = e.detail.index;
      var period = this._cleanPeriod(this.periods[index]);
      this.periodsData.value.splice(index, 1);
      this.periodsData.value.splice(index + 1, 0, period);
      setTimeout(e.detail.callback);
      this._periodsSave();
    },

    delete: function (e) {
      this.periodsData.value.splice(e.detail, 1);
      this._periodsSave();
    },

    updatePeriodHandler: function (e) {
      var period = _.clone(e.detail.period);
      var target = e.target;
      if (e.detail.refresh) {
        this.updatePeriod(e.detail.index, period);
      } else {
        this.periods[e.detail.index] = period;
      }
    },

    toggleSelectAll: function (e) {
      return e.target.checked ? this.selectAll() : setTimeout(this.clearSelected.bind(this));
    },

    // Functions
    _cleanPeriod: function (period) {
      return _.omit(_.clone(period), ['select', 'deselect']);
    },

    _periodsSave: _.debounce(function () {
      this.periodsData.value = this.periodsData.value.map(function (period) {
        return this._cleanPeriod(period);
      }.bind(this));
      this.notifyPath('periodsData.value');
    }, 50),

    reset: function () {
      this.timerNameData.value = newTimerName;
      this.timerDescriptionData.value = newTimerDescription;
      this.notifyPath('timerNameData.value');
      if (this.periodsData && this.periodsData.value) {
        this.periodsData.value.splice(0, this.periodsData.value.length);
        this.notifyPath('periodsData.value');
      }
      this.splice('periods', 0, this.periods.length);
    },

    save: function () {
      var timer = {
        name: this.timerName,
        description: this.timerDescription,
        periods: this.periodsData.value.map(function (period) {
          return this._cleanPeriod(period);
        }.bind(this)).filter(function(period, i) {
          return i == 0 || period.type !== 'prepare';
        }),
        totalSeconds: this.totalSeconds,
        updated: Date.now()
      };
      if (!this.timersData.value) this.timersData.value = [];
      if (this.timerKey != 'new') {
        timer.$key = this.timersData.value[+this.timerKey].$key;
        this.timersData.value.splice(+this.timerKey, 1, timer);
      } else {
        this.timersData.value.push(timer);
      }
      this.notifyPath('timersData.value');
      this.reset();
      this.saveStorage();
      this.fire('redirect', '/timers');  
    },

    saveStorage: function() {
      this.$.periodsStorage.save();
      this.$.timerNameStorage.save();
      this.$.timerDescriptionStorage.save();
      this.$.timersStorage.save();
    },

    editName: function () {
      this.fire('openDialog', {
        id: 'itemNameDialog',
        name: this.timerName,
        callback: function (name) {
          this.set('timerNameData.value', name || 'Mistake!!!');
        }.bind(this)
      });
    },

    editDescription: function () {
      this.fire('openDialog', {
        id: 'itemDescriptionDialog',
        description: this.timerDescription == newTimerDescription ? '' : this.timerDescription,
        callback: function (description) {
          this.set('timerDescriptionData.value', description);
        }.bind(this)
      });
    },

    addWork: function () {
      this.addPeriod('work');
    },

    addRest: function () {  
      this.addPeriod('rest');
    },

    addStopwatch: function () {
      this.addPeriod('stopwatch');
    },

    addDefaultPeriod: _.debounce(function () {
      setTimeout(function () {
        this.addPeriod('prepare');
      }.bind(this));
    }, 50),

    addPeriod: function (type) {
      if (!this.periodsData.value) this.periodsData.value = [];
      if (type == 'prepare' && !this.periodsData.value.filter(function (period) {
        return !!period.type == 'prepare';
      })) return;
      this.periodsData.value.push(this.getPeriodDefault(type, true));
      this._periodsSave();

    },

    updatePeriod: function (index, period) {
      this.periodsData.value[index] = this._cleanPeriod(period);
      this._periodsSave();
    },

    selectAll: function () {
      this.periodsData.value.forEach(function (period, index) {
        if (period.type !== 'prepare') {
          period.selected = true;
        }
      }.bind(this));
      this.periods.forEach(function (period, index) {
        if (period.type !== 'prepare') {
          period.selected = true;
          period.select();
        }
      }.bind(this));
      this._periodsSave();
    },

    clearSelected: _.debounce(function () {
      if (!this.periodsData.value) return;
      this.periodsData.value.forEach(function (period, index) {
        if (period.type !== 'prepare') {
          period.selected = false;
        }
      }.bind(this));
      this.periods.forEach(function (period, index) {
        if (period.type !== 'prepare') {
          period.selected = false;
          period.deselect();
        }
      }.bind(this));
      this._periodsSave();
      this.$.toggleCheckbox.set('checked', false);
    }, 50),

    duplicateSelected: function (e) {
      this.periods.forEach(function (period, index) {
        if (period.selected) {
          var newPeriod = this._cleanPeriod(this.periodsData.value[index]);
          newPeriod.selected = false;
          this.periodsData.value.push(newPeriod);
        }
      }.bind(this));
      this.clearSelected();
    },

    deleteSelected: function () {
      var i = this.periods.length;
      while (i--) {
        if (this.periods[i].selected) {
          this.periodsData.value.splice(i, 1);
        }
      }
      this.clearSelected();
    },

  });
</script>
</dom-module>