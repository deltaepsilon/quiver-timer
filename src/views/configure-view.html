<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<link rel="import" href="../shared-styles.html">
<link rel="import" href="../color-wheel.html">
<link rel="import" href="../timer-behavior/timer-defaults.html">
<link rel="import" href="../digital-clock/digital-clock.html">
<link rel="import" href="../configure-timer/configure-period.html">

<script src="../../bower_components/lodash/lodash.js"></script>

<dom-module id="configure-view">
  <template>
    <style include="shared-styles color-wheel">
      :host {
        display: block;
      }
      
      #buttons {
        @apply(--layout-horizontal);
        @apply(--layout-justified);
        @apply(--layout-wrap);
      }
      
      #buttons paper-button {
        @apply(--layout-flex);
      }
      
      
    </style>

    <app-route route="{{localRoute}}" pattern="/:timerKey" data="{{routeData}}" tail="{{subroute}}"></app-route>
    <app-localstorage-document id="timersStorage" key="timers" data="{{timers}}"></app-localstorage-document>
    <app-localstorage-document id="nameStorage" key="editing-name" data="{{editingName}}" zero-value=""></app-localstorage-document>
    <app-localstorage-document id="periodsStorage" key="editing-periods" data="{{editingPeriods}}" zero-value="[]"></app-localstorage-document>

    <template id="editingPeriods" is="dom-repeat" items="[[editingPeriods]]" as="period">
      <configure-period period="{{period}}" on-period-updated="updatePeriod" index="[[index]]" periods-count="[[editingPeriods.length]]"></configure-period>
    </template>
    <div id="buttons" style="margin: .5rem 1rem; padding: .5rem 1rem;">
      <!--<paper-button raised class="primary" on-click="addWork">+ Work</paper-button>
      <paper-button raised class="secondary" on-click="addRest">+ Rest</paper-button>
      <paper-button raised class="tertiary" on-click="addStopwatch">+ Stopwatch</paper-button>-->
      <paper-icon-button icon="hourglass-empty" on-click="addWork"></paper-icon-button>
      <paper-icon-button icon="av:pause-circle-outline" on-click="addRest"></paper-icon-button>
      <paper-icon-button icon="custom:stopwatch" on-click="addStopwatch"></paper-icon-button>
    </div>
  </template>
  <script>
    Polymer({
      is: "configure-view",

      behaviors: [TimerDefaults],

      properties: {
        localRoute: Object,
        title: {
          type: String,
          notify: true,
          computed: '_title(name)'
        },
        timers: {
          type: Array,
          value: []
        },
        editingName: {
          type: String,
          value: 'Timer'
        },
        editingPeriods: {
          type: Array,
          value: []
        }
      },

      _title: function(name) {
        return name;
      },

      // Observers
      observers: ['_setEditing(routeData.timerKey)'],

      _setEditing: function(timerKey) {
        if (this.timers[timerKey]) {
          this.set('name', timers[timerKey].name);
          this.set('periods', timers[timerKey].periods);  
        }

        if (!this.editingPeriods.length) this.addPeriod('prepare'); 
      },

      listeners: {
        moveUp: 'moveUp',
        moveDown: 'moveDown',
        delete: 'delete'
      },

      moveUp: function(e) {
        if (e.detail < 1) return console.log('skipping up');
        var index = e.detail;
        var period = _.clone(this.editingPeriods[index]);
        this.splice('editingPeriods', index, 1);
        this.splice('editingPeriods', index - 1, 0, period);
      },

      moveDown: function(e) {
        if (e.detail >= this.editingPeriods.length - 1) return console.log('skipping up');
        var index = e.detail;
        var period = _.clone(this.editingPeriods[index]);
        this.splice('editingPeriods', index, 1);
        this.splice('editingPeriods', index + 1, 0, period);
      },

      delete: function(e) {
        this.splice('editingPeriods', e.detail, 1);
      },

      // Functions

      addWork: function() {
        this.addPeriod('work');
      },

      addRest: function() {
        this.addPeriod('rest');
      },

      addStopwatch: function() {
        this.addPeriod('stopwatch');
      },

      addPeriod: function(type) {
        this.push('editingPeriods', this.getPeriodDefault(type, true));
        // setTimeout(function() {
        //   this.fire('scrollIntoView', this.$.buttons);  
        // }.bind(this), 750);
      },

      updatePeriod: function(e) {
        this.splice('editingPeriods', e.detail.index, 1, e.detail.period);
      },


    });
  </script>
</dom-module>