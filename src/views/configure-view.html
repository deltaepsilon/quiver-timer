<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-storage/app-indexeddb-mirror/app-indexeddb-mirror.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-styles/shadow.html">

<link rel="import" href="../shared-styles.html">
<link rel="import" href="../color-wheel.html">
<link rel="import" href="../timer-behavior/timer-defaults.html">
<link rel="import" href="../digital-clock/digital-clock.html">
<link rel="import" href="../configure-timer/configure-period.html">

<script src="../../bower_components/lodash/lodash.js"></script>

<dom-module id="configure-view">
  <template>
    <style include="shared-styles color-wheel">
      :host {
        display: block;
      }
      #periods-wrapper {
        @apply(--shadow-elevation-2dp);
      }
    </style>

    <app-route route="{{localRoute}}" pattern="/:timerKey" data="{{routeData}}" tail="{{subroute}}"></app-route>
    <app-indexeddb-mirror id="timersData" key="timers" session="[[session]]" data="{{timers}}" persisted-data="{{timersData}}"></app-indexeddb-mirror>
    <app-indexeddb-mirror id="nameData" key="timer-name" session="[[session]]" data="{{timerName}}" persisted-data="{{timerNameData}}"></app-indexeddb-mirror>
    <app-indexeddb-mirror id="periodsData" key="periods" session="[[session]]" data="{{periods}}" persisted-data="{{periodsData}}"></app-indexeddb-mirror>
    <!--<app-localstorage-document id="timersStorage" key="timers" data="{{timers}}"></app-localstorage-document>
    <app-localstorage-document id="nameStorage" key="timer-name" data="{{timerName}}" zero-value=""></app-localstorage-document>
    <app-localstorage-document id="periodsStorage" key="editing-periods" data="{{periodsStorage}}" zero-value="[]"></app-localstorage-document>-->

    <paper-material elevation="1" class="layout horizontal justified">
      <h3 on-click="editName">[[timerName]]</h3>
      <digital-clock total-seconds="[[totalSeconds]]" style="margin: 21px 50px 0 0;"></digital-clock>
    </paper-material>
    <div style="padding: 0rem 1rem 6rem;">
      <div id="periods-wrapper">
        <template id="periods" is="dom-repeat" items="[[periods]]" as="period">
          <configure-period class="divided" period="{{period}}" on-period-updated="updatePeriodHandler" index="[[index]]" periods-count="[[periods.length]]"></configure-period>
        </template>  
      </div>  
      <template is="dom-if" if="[[showSelectAll]]">
        <div class="layout horizontal end-justified" style="padding: 30px 24px;">
          <paper-checkbox on-checked-changed="toggleSelectAll"></paper-checkbox>  
        </div>
      </template>
    </div>
  </template>
  <script>
    var newTimerName = 'New Timer';
    Polymer({
      is: "configure-view",

      behaviors: [TimerDefaults],

      properties: {
        localRoute: Object,
        session: String,
        title: {
          type: String,
          notify: true,
          computed: '_title(timerName)'
        },
        timers: {
          type: Array,
          value: []
        },
        timerName: {
          type: String,
          value: newTimerName
        },
        periods: {
          type: Array,
          value: []
        },
        totalSeconds: {
          type: Number,
          computed: '_totalSeconds(periods, periods.splices)'
        },
        periodsStorage: {
          type: Array,
          value: []
        },
        selected: {
          type: Array,
          value: [],
          notify: true
        },
        bulk: {
          type: Boolean,
          computed: '_bulk(periods, periods.splices)',
          notify: true
        },
        sheetPayload: {
          type: Object,
          notify: true
        },
        storageReady: Boolean,
        showSelectAll: {
          type: Boolean,
          computed: '_showSelectAll(periods.length)'
        }
      },

      attached: function() { 
        // var loadPeriodStorage = function(e) {
        //   this.$.periodsStorage.removeEventListener('data-changed', loadPeriodStorage);
        //   if (!this.periods.length < 2 && e.detail.value.length) {
        //     this.splice.apply(this, ['periods', 0, this.periods.length].concat(e.detail.value));
        //   }
        //   this.storageReady = true;
        // }.bind(this);
        // this.$.periodsStorage.addEventListener('data-changed', loadPeriodStorage);
        this.fire('timerFab', {
          callback: this.save.bind(this)
        });
        this.sheetPayload = this._sheetPayload();
      },

      _title: function(name) {
        return name;
      },

      // Observers
      observers: [
        '_setEditing(routeData.timerKey, storageReady, timers)',
        '_periods(periods, periods.splices)'
      ],

      _setEditing: function(timerKey, storageReady, timers) {
        if (storageReady && timers[timerKey]) {
          this.set('timerName', timers[timerKey].name);
          this.set('periods', timers[timerKey].periods);  
        }

        if (!this.periods.length) this.addPeriod('prepare'); 
      },

      _periods: function(periods) {
        this.periodsStorage = periods;
        this.$.periodsStorage.save('editing-periods');
      },

      _totalSeconds: function(periods) {
        return periods.reduce(function(seconds, period) {
          return seconds + period.totalSeconds;
        }, 0);
      },

      _bulk: function(periods) {
        return !!periods.find(function(period) {
          return period.selected;
        });
      },

      _sheetPayload: function() {
        return {
          cancel: this.clearSelected.bind(this),
          duplicate: this.duplicateSelected.bind(this),
          delete: this.deleteSelected.bind(this),
          addWork: this.addWork.bind(this),
          addRest: this.addRest.bind(this),
          addStopwatch: this.addStopwatch.bind(this),
        };
      },

      _showSelectAll: function(i) {
        return i > 2;
      },

      // Listeners
      listeners: {
        moveUp: 'moveUp',
        moveDown: 'moveDown',
        delete: 'delete',
        select: 'select'
      },

      moveUp: function(e) {
        if (e.detail < 1) return console.log('skipping up');
        var index = e.detail.index;
        var period = _.clone(this.periods[index]);
        this.splice('periods', index, 1);
        this.splice('periods', index - 1, 0, period);
        setTimeout(e.detail.callback);
      },

      moveDown: function(e) {
        if (e.detail >= this.periods.length - 1) return console.log('skipping up');
        var index = e.detail.index;
        var period = _.clone(this.periods[index]);
        this.splice('periods', index, 1);
        this.splice('periods', index + 1, 0, period);
        setTimeout(e.detail.callback);
      },

      delete: function(e) {
        this.splice('periods', e.detail, 1);
      },

      updatePeriodHandler: function(e) {
        var period = e.detail.period;
        var target = e.target;
        period.select = target.select.bind(target);
        period.deselect = target.deselect.bind(target);
        if (e.detail.refresh) {
          this.updatePeriod(e.detail.index, period);
        } else {
          this.periods[e.detail.index] = period;
        }
      },

      toggleSelectAll: function(e) {
        return e.target.checked ? this.selectAll() : this.clearSelected();
      },

      // Functions
      reset: function() {
        this.set('timerName', newTimerName);
        this.splice('periods', 0, this.periods.length);
      },

      save: function() {
        var timer = {
          name: this.timerName,
          periods: this.periods,
          totalSeconds: this.totalSeconds,
          updated: Date.now()
        };
        if (this.timerKey) {
          this.splice('timers', this.timerKey, 1, timer);
        } else {
          this.push('timers', timer);
        }
        this.reset();
        this.fire('back');
        // this.fire('goTo', {
        //   state: {},
        //   title: 'Timers',
        //   url: '/timers'
        // });  
      },

      editName: function() {
        this.fire('openDialog', {
          id: 'itemNameDialog',
          name: this.timerName,
          callback: function(name) {
            this.set('timerName', name || 'Fred Timer');
          }.bind(this)
        });
      },

      addWork: function() {
        this.addPeriod('work');
      },

      addRest: function() {
        this.addPeriod('rest');
      },

      addStopwatch: function() {
        this.addPeriod('stopwatch');
      },

      addPeriod: function(type) {
        this.push('periods', this.getPeriodDefault(type, true));
      },

      updatePeriod: function(index, period) {
        setTimeout(function() {
          this.splice('periods', index, 1, period);  
        }.bind(this));
      },

      selectAll: function() {
        this.periods.forEach(function(period, index) {
          if (period.type !== 'prepare' && !period.selected) {
            period.select();
            period.selected = true;
            this.updatePeriod(index, period);
          }           
        }.bind(this));
      },

      clearSelected: function() {
        this.periods.forEach(function(period, index) {
          if (period.selected) {
            period.deselect();
            period.selected = false;
            this.updatePeriod(index, period);  
          }
        }.bind(this));
      },

      duplicateSelected: function(e) {
        this.periods.forEach(function(period, index) {
          if (period.selected) this.push('periods', this.periodsStorage[index]);
        }.bind(this));
        this.clearSelected();
      },

      deleteSelected: function() {
        var i = this.periods.length;
        while (i--) {
          if (this.periods[i].selected) this.splice('periods', i, 1);
        }
        this.clearSelected();
      },

    });
  </script>
</dom-module>