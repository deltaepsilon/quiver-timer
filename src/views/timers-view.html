<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">

<link rel="import" href="../digital-clock/digital-clock.html">
<link rel="import" href="../timer-behavior/timer-defaults.html">
<link rel="import" href="../datastores/quiver-store-behavior.html">
<link rel="import" href="../shared-styles.html">

<script src="../third-party/lodash.custom.min.js"></script>

<dom-module id="timers-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
      
      .show-on-focus {
        display: none !important;
      }
      
      paper-icon-item[focused] .show-on-focus {
        display: inherit !important;
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        background: white;
      }

      .list {
        margin-bottom: 6rem;
      }

      #add {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 1;
      }

      paper-icon-button {
        color: var(--dark-primary-color) ;
      }

      paper-menu-button {
        position: absolute;
        right: 0;
        background: var(--color-white);
        padding-bottom: 0;
      }

      paper-toolbar {
        margin: 1rem;
      }

      .timer-name {
        overflow: hidden;
        text-overflow: ellipsis;
        width: calc(100% - 3.2rem);
      }
    </style>

<a id="add" href="/configure/new">
  <paper-fab icon="add"></paper-fab>
</a>



<template is="dom-if" if="[[!account]]">
  <paper-toolbar class="layout horizontal center-justified">
    <paper-button on-click="guestModeDialog">Guest Mode</paper-button>
  </paper-toolbar>
</template>

<template is="dom-if" if="[[showVerifyEmail]]">
  <div class="layout horizontal center-justified">
    <paper-button class="primary" on-click="verifyEmail">Verify Email</paper-button>
  </div>
</template>

<template is="dom-if" if="[[timers.length]]">
  <paper-material class="list" elevation="1">
    <template is="dom-repeat" items="[[timers]]" as="timer">
      <div>
        <paper-icon-item two-line style="padding: 0;">
<a class="flex layout horizontal center-justified" href="/timer/[[index]]/stopped" item-icon>
  <paper-icon-button icon="av:play-circle-outline"></paper-icon-button>
</a>
<paper-item-body>
  <div class="layout horizontal justified center">
    <div class="flex">
      <div class="timer-name">
        <strong>[[timer.name]]</strong>
      </div>
      <div secondary>
        <digital-clock total-seconds="[[timer.totalSeconds]]"></digital-clock>
      </div>
    </div>
    <paper-menu-button>
      <paper-icon-button icon="more-vert" class="dropdown-trigger"></paper-icon-button>
      <paper-menu class="dropdown-content">
        <paper-item>
          <a href="/configure/[[index]]">
            <paper-icon-button icon="editor:mode-edit"></paper-icon-button>
          </a>
        </paper-item>
        <paper-item>
          <paper-icon-button icon="content-copy" on-click="duplicate" index="[[index]]"></paper-icon-button>
        </paper-item>
        <paper-item>
          <paper-icon-button icon="delete" on-click="delete" index="[[index]]"></paper-icon-button>
        </paper-item>
      </paper-menu>
    </paper-menu-button>
  </div>
</paper-item-body>
</paper-icon-item>
</div>
</template>
</paper-material>
</template>
</template>
<script>
  Polymer({
    is: "timers-view",

    behaviors: [TimerDefaults, QuiverStoreBehavior],

    properties: {
      account: Object,
      timers: {
        type: Array,
        statePath: 'timers'
      },
      ready: {
        type: Boolean,
        value: false
      },
      showVerifyEmail: {
        type: Boolean,
        computed: '_showVerifyEmail(user.isAnonymous, user.emailVerified)'
      }
    },

    // Observers
    observers: ['_restoreDefaults(timersData, ready)'],

    _restoreDefaults: function (timers, ready) {
      if (ready && timers._rev && !timers.value) {
        this.restoreDefaults();
      }
    },

    _timers: function (timers) {
      return timers ? timers.slice(0) : [];
    },

    _showVerifyEmail: function(isAnonymous, emailVerified) {
      return !isAnonymous && !emailVerified;
    },

    //  Listeners
    _data: function (e) {
      if (e.detail.value._id) {
        this.ready = true;
      };
    },

    // Functions
    duplicate: function (e) {
      this.dispatch({
        type: 'duplicateTimer',
        index: +e.target.index
      });
    },

    delete: function (e) {
      this.dispatch({
        type: 'deleteTimer',
        index: +e.target.index
      });
    },

    restoreDefaults: function () {
      this.dispatch({
        type: 'restoreDefaults'
      });
    },

    verifyEmail: function () {
      this.fire('verifyEmail');
    },

    guestModeDialog: function() {
     this.fire('openDialog', {id: 'guestModeDialog'}) 
    }
  });
</script>
</dom-module>