<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-pouchdb/app-pouchdb-document.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<link rel="import" href="../shared-styles.html">
<link rel="import" href="../color-wheel.html">
<link rel="import" href="../digital-clock/digital-clock.html">
<link rel="import" href="../timer-state/timer-stopped.html">
<link rel="import" href="../timer-state/timer-playing.html">
<link rel="import" href="../timer-state/timer-paused.html">

<script src="../../bower_components/timer.js/dist/timer.js"></script>

<dom-module id="timer-view">
  <template>
    <style include="shared-styles color-wheel">
      :host {
        display: block;
      }
      
      #wrapper .show-stopped {
        display: none;
      }
      
      #wrapper .show-paused {
        display: none;
      }
      
      #wrapper .show-playing {
        display: none;
      }
      
      #wrapper[state="stopped"] .show-stopped {
        display: inherit;
      }
      
      #wrapper[state="paused"] .show-paused {
        display: inherit;
      }
      
      #wrapper[state="playing"] .show-playing {
        display: inherit;
      }
    </style>

    <app-route route="{{localRoute}}" pattern="/:timerKey" data="{{routeData}}" tail="{{subroute}}"></app-route>
    <app-route route="{{subroute}}" pattern="/:state" data="{{subrouteData}}"></app-route>
    <app-pouchdb-document id="timersStorage" db-name="quiver-timer" doc-id="timers" data="{{timersData}}"></app-pouchdb-document>

    <iron-pages selected="[[state]]" attr-for-selected="name" fallback-selection="stopped" role="main">
      <timer-stopped id="timerStopped" name="stopped" timer-key="[[timerKey]]" timer="[[timer]]"></timer-stopped>
      <timer-playing id="timerPlaying" name="playing" seconds="[[seconds]]" periods="[[workingPeriods]]"></timer-playing>
      <timer-paused id="timerPaused" name="paused" seconds="[[seconds]]" periods="[[workingPeriods]]"></timer-paused>
    </iron-pages>
  </template>
  <script>
    Polymer({
       is: "timer-view",

       properties: {
         localRoute: Object,
         timerKey: {
           type: Number,
           computed: '_timerKey(routeData.timerKey)'
         },
         timersData: Object,
         timer: {
           type: Object,
           computed: '_timer(timerKey, timersData.value)'
         },
         state: {
           type: String,
           computed: '_state(subrouteData)'
         },
         clock: {
           type: Object,
           value: function() {
             return new Timer({
               tick: 1,
               ontick: this.tickHandler.bind(this),
              //  onstop: function() {
              //    console.log('timer stopped');
              //  },
              //  onstart: function() {
              //    console.log('timer started');
              //  }
             });
           }
         },
         seconds: Number,
         workingPeriods: {
           type: Array,
           value: []
         }
       },

       attached: function() {
         this.stop();
       },

       //  Observers
       observers: [
         '_timerFab(state)',
         '_clock(state, timer.periods, clock)',
         '_workingPeriods(workingPeriods, timer.periods)'
       ],

       _timerFab: function(state) {
         switch (true) {
           case state == 'playing':
              this.play();
              break;
           case state == 'paused':
              this.pause();
              break;
           case state == 'stopped':
              this.stop();
              break;
         }
       },

       _clock: function(state, periods, clock) {
         if (state == 'paused') {
           clock.pause();
         } else if (state == 'stopped') {
           clock.stop();
         } else if (state == 'playing') {
           if (clock.getDuration()) {
             clock.start();
           } else {
             clock.start(periods.reduce(function(s, period) {
               return s += period.totalSeconds;
             }, 1));
           }
         }
       },

       _timerKey: function(timerKey) {
         return +timerKey;
       },

       _state: function(subrouteData) {
         return subrouteData.state || 'stopped';
       },

       _timer: function(timerKey, timers) {
         var timer = timers[timerKey];
         timer.periods = timer.periods.map(function(period, i) {
          return period.color = Math.round(i/18%1*18), period;  
         });
         return timer;
       },

       _workingPeriods: function(workingPeriods, periods) {
         if (periods) {
           this.splice.apply(this, ['workingPeriods', 0, this.workingPeriods.length].concat(_.cloneDeep(periods)));
         }
       },

       //Listeners
       listeners: {
         play: 'play',
         pause: 'pause',
         stop: 'stop',
         end: 'end',
         previous: 'previous',
         next: 'next'
       },

       play: function() {
         this.state = 'playing';
         this.fire('timerFab');
       },

       pause: function() {
         this.state = 'paused';
         this.fire('timerFab', {
           icon: 'av:play-arrow',
           url: '/timer/' + this.timerKey + '/playing'
         });
       },

       stop: function() {
         this.state = 'stopped';
         this.fire('timerFab', {
           icon: 'av:play-arrow',
           url: '/timer/' + this.timerKey + '/playing'
         });
       },

       end: function() {
         var timerView = this;
         this.fire('timerFab', {
           icon: 'av:stop',
           url: '/timer/' + this.timerKey + '/stopped'
         });
       },

       previous: function() {
         var prevSeconds = this.period.totalSeconds - this.periodSeconds + 2;
         if (prevSeconds < 5 && this.periodIndex) {
           prevSeconds += this.timer.periods[this.periodIndex - 1].totalSeconds;
         }
         this.clock.stop();
         this.clock.start(this.seconds + prevSeconds);
       },

       next: function() {
         this.clock.stop();
         this.clock.start(this.seconds - this.periodSeconds + 2);
       },

       tickHandler: function(ms) {
         this.seconds = Math.round(ms/1000) - 1;
       }
    });
  </script>
</dom-module>