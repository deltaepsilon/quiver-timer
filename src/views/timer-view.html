<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-pouchdb/app-pouchdb-document.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../shared-styles.html">
<link rel="import" href="../color-wheel.html">
<link rel="import" href="../digital-clock/digital-clock.html">
<link rel="import" href="../timer-state/timer-stopped.html">
<link rel="import" href="../timer-state/timer-playing.html">
<link rel="import" href="../timer-state/timer-paused.html">

<dom-module id="timer-view">
  <template>
    <style include="shared-styles color-wheel">
      :host {
        display: block;
      }

      #wrapper .show-stopped {
        display: none;
      }

      #wrapper .show-paused {
        display: none;
      }

      #wrapper .show-playing {
        display: none;
      }

      #wrapper[state="stopped"] .show-stopped {
        display: inherit;
      }

      #wrapper[state="paused"] .show-paused {
        display: inherit;
      }

      #wrapper[state="playing"] .show-playing {
        display: inherit;
      }
    </style>

    <app-route route="{{localRoute}}" pattern="/:timerKey" data="{{routeData}}" tail="{{subroute}}"></app-route>
    <app-pouchdb-document id="timersStorage" db-name="quiver-timer" doc-id="timers" data="{{timersData}}"></app-pouchdb-document>

    <div id="wrapper" state$="[[state]]">
      <timer-stopped class="show-stopped" state="[[state]]" timer-key="[[timerKey]]" timer="[[timer]]"></timer-stopped>
      <timer-playing class="show-playing" state="[[state]]" title="[[timer.name]]" periods="timer.periods"></timer-playing>
      <timer-paused class="show-paused" state="[[state]]" title="[[timer.name]]" periods="timer.periods"></timer-paused>
    </div>
  </template>
  <script>
    Polymer({
       is: "timer-view",

       properties: {
         localRoute: Object,
         timerKey: {
           type: Number,
           computed: '_timerKey(routeData.timerKey)'
         },
         timersData: Object,
         timer: {
           type: Object,
           computed: '_timer(timerKey, timersData.value)'
         },
         state: {
           type: String,
           value: 'stopped'
         }
       },

       attached: function() {
         this.fire('timerFab', {
           icon: 'av:play-arrow',
           callback: this.play.bind(this)
         });
       },

       //  Observers
       _timerKey: function(timerKey) {
         return +timerKey;
       },

       _handleData: function(e) {
         this.splice.apply(this, ['timers', 0, this.timers.length].concat(e.detail.value));
         console.log('e timer', e);
       },

       _timer: function(timerKey, timers) {
         var timer = timers[timerKey];
         timer.periods = timer.periods.map(function(period, i) {
          return period.color = Math.round(i/18%1*18), period;  
         });
         return timer;
       },

       //Listeners
       listeners: {
         play: 'play',
         pause: 'pause',
         stop: 'stop'
       },

       play: function() {
         this.state = 'playing';
         this.fire('timerFab', {
           icon: 'av:pause',
           callback: this.pause.bind(this)
         });
       },

       pause: function() {
         this.state = 'paused';
         this.fire('timerFab', {
           icon: 'av:play-arrow',
           callback: this.play.bind(this)
         });
       },

       stop: function() {
         this.state = 'stopped';
         this.fire('timerFab', {
           icon: 'av:play-arrow',
           callback: this.play.bind(this)
         });
       }
    });
  </script>
</dom-module>