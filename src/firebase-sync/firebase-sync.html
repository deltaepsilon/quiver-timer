<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../firebase-behavior/firebase-behavior.html">
<link rel="import" href="../datastores/quiver-store-behavior.html">
<link rel="import" href="../shared-styles.html">

<script src="../third-party/lodash.custom.min.js"></script>

<dom-module id="firebase-sync">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>

</template>
<script>
  Polymer({
    is: "firebase-sync",

    behaviors: [FirebaseBehavior, QuiverStoreBehavior],

    properties: {
      firebase: Object,
      model: Object,
      connected: {
        type: Boolean,
        value: false
      },
      account: Object
    },

    attached: function() {
      this.store.subscribe(function() {
        this.state = this.store.getState();
        this.sync();
      }.bind(this));
    },

    observers: [
      '_startSync(connected, model, account.uid, account.isAnonymous)'
    ],

    _startSync: function (connected, model, uid, isAnonymous) {
      if (this.handler && this.stateRef && !connected || isAnonymous) {
        this.stateRef.off('value', this.handler);
        this.stateRef = undefined;
        this.handler = undefined;
      } else if (!this.handler && !this.stateRef) {
        this.stateRef = this.firebase.database().ref(this.replaceWildcard(model.user.owned.state, 'uid', uid));
        this.handler = this.stateRef.on('value', function (snap) {
          this.firebaseState = snap.val();
          this.sync();
        }.bind(this));
      }
    },

    sync: function() {
      if (!this.connected || !this.stateRef) return;

      if (!this.firebaseState || !this.firebaseState.version || this.firebaseState.version <= this.state.version) {
        this.stateRef.update({
          timers: this.state.timers.reduce(function(timers, timer) {
            return timers[timer.$key] = _.omit(timer, ['$key']), timers;
          }, {}),
          version: this.state.version
        });
      } else if (this.firebaseState && this.firebaseState && this.firebaseState.version > this.state.version) {
        var timers = [];
        var timer;

        for (var key in this.firebaseState.timers) {
          timer = this.firebaseState.timers[key];
          timer.$key = key;
          timers.push(timer);
        }

        this.dispatch({
          type: 'setTimers',
          timers: timers,
          version: this.firebaseState.version
        });
      }
    }
  });
</script>
</dom-module>